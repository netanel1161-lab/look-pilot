<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>כלי איסוף נתוני רכב - JSON Generator</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f1f5f9;
        }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        // Fix for Lucide Icons in browser
        const LucideIcons = Object.keys(window.lucide.icons).reduce((acc, key) => {
            const pascalKey = key.charAt(0).toUpperCase() + key.slice(1);
            const IconData = window.lucide.icons[key];
            acc[pascalKey] = ({ className, size = 24, ...props }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                    {IconData.children && IconData.children.map((child, idx) => React.createElement(child[0], { ...child[1], key: idx }))}
                </svg>
            );
            return acc;
        }, {});

        // FIX: Changed 'Image as ImageIcon' to 'Image: ImageIcon'
        const { Plus, Download, Trash2, Link: LinkIcon, Database, FileJson, User, Car, X, Copy, UploadCloud, Eye, Image: ImageIcon, RefreshCw } = LucideIcons;

        function DataCollectorApp() {
            // --- State ---
            const [vehiclePool, setVehiclePool] = useState([]);
            
            const [formData, setFormData] = useState({
                plate: '',
                link: '',
                brand: '',
                model: '',
                year: '2020',
                color: 'white',
                responsible: '',
                notes: ''
            });

            const [carList, setCarList] = useState([]);
            
            // Preview State
            const [previewSrc, setPreviewSrc] = useState(null);
            const [previewError, setPreviewError] = useState(false);

            // --- Load External Data Logic ---
            useEffect(() => {
                console.log("Attempting to fetch ./data/Vehicle_pool.json...");
                fetch('./data/Vehicle_pool.json')
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        console.log("Loaded vehicle pool successfully:", data.length, "items");
                        setVehiclePool(data);
                    })
                    .catch(error => {
                        console.warn("Could not auto-load JSON. Use manual upload if running locally without a server.", error);
                    });
            }, []);

            const handleVehiclePoolUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        setVehiclePool(data);
                        alert(`נטענו בהצלחה ${data.length} דגמי רכבים למערכת!`);
                    } catch (err) {
                        alert("שגיאה בקריאת קובץ ה-JSON. וודא שהפורמט תקין.");
                    }
                };
                reader.readAsText(file);
            };

            const uniqueMakes = useMemo(() => {
                if (!vehiclePool.length) return [];
                return [...new Set(vehiclePool.map(item => item.make))].sort();
            }, [vehiclePool]);

            // --- Logic Helpers ---
            const constructUrl = (make, model, year, color, view) => {
                const cleanMake = make.toLowerCase().replace(/\s+/g, '-');
                const cleanModel = model.toLowerCase().replace(/\s+/g, '-');
                const baseUrl = "https://hnsgimjxowxjjcdypvjw.supabase.co/storage/v1/object/public/cars";
                return `${baseUrl}/${cleanMake}/${cleanModel}/${year}/${color}_${view}.webp`;
            };

            // --- Handlers ---
            const handleInputChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
                
                if (name === 'brand') {
                    const firstModel = vehiclePool.find(c => c.make === value)?.modelFamily;
                    setFormData(prev => ({ ...prev, brand: value, model: firstModel || '' }));
                }
            };

            // Extract data from Link
            const handleUrlImport = () => {
                const importUrl = formData.link;
                if (!importUrl) {
                    alert("נא להדביק קישור בשדה הקישור");
                    return;
                }
                try {
                    const regex = /cars\/([^\/]+)\/([^\/]+)\/(\d{4})\/([a-z]+)_([a-z]+)\.webp/;
                    const match = importUrl.match(regex);

                    if (match) {
                        const [, make, model, yearStr, colorStr] = match;
                        
                        const normalizedMake = uniqueMakes.find(m => m.toLowerCase() === make.toLowerCase()) || make.charAt(0).toUpperCase() + make.slice(1);
                        
                        let normalizedModel = model.charAt(0).toUpperCase() + model.slice(1);
                        if (vehiclePool.length > 0) {
                            const foundModel = vehiclePool.find(c => c.modelFamily.toLowerCase() === model.toLowerCase());
                            if (foundModel) normalizedModel = foundModel.modelFamily;
                        }

                        setFormData(prev => ({
                            ...prev,
                            brand: normalizedMake,
                            model: normalizedModel,
                            year: yearStr,
                            color: colorStr
                        }));
                        
                        // Show preview immediately
                        setPreviewSrc(importUrl);
                        setPreviewError(false);
                    } else {
                        alert("קישור לא תקין. נסה שוב.");
                    }
                } catch (e) {
                    alert("שגיאה בפענוח.");
                }
            };

            // Find Image based on Details
            const handleFindImage = (viewType) => {
                const { brand, model, year, color, link } = formData;
                
                // If link exists, try to use it (or modify it for the requested view)
                if (link && link.includes('supabase')) {
                    // Try to flip view in existing link
                    const newLink = link.replace(/_(side|main)\.webp/, `_${viewType}.webp`);
                    setPreviewSrc(newLink);
                    setPreviewError(false);
                    setFormData(prev => ({ ...prev, link: newLink })); // Update link field
                    return;
                }

                if (!brand || !model || !year || !color) {
                    alert("נא למלא יצרן, דגם, שנה וצבע כדי לחפש תמונה.");
                    return;
                }

                // Construct URL
                const generatedUrl = constructUrl(brand, model, year, color, viewType);
                setPreviewSrc(generatedUrl);
                setPreviewError(false);
                setFormData(prev => ({ ...prev, link: generatedUrl })); // Update link field automatically
            };

            const addToList = (e) => {
                e.preventDefault();
                if (!formData.plate) {
                    alert("חובה להזין מספר רכב (לוחית רישוי)");
                    return;
                }

                setCarList(prev => [...prev, { ...formData }]);
                
                setFormData(prev => ({
                    ...prev,
                    plate: '',
                    link: '', 
                    notes: ''
                }));
                setPreviewSrc(null); // Clear preview
            };

            const removeFromList = (index) => {
                setCarList(prev => prev.filter((_, i) => i !== index));
            };

            const downloadFullJSON = () => {
                if (carList.length === 0) return;
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(carList, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `cars_FULL_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const downloadLinksJSON = () => {
                if (carList.length === 0) return;
                const linksData = carList.map(item => ({
                    plate: item.plate,
                    link: item.link
                }));
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(linksData, null, 2));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", `cars_LINKS_${new Date().toISOString().slice(0,10)}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            return (
                <div className="max-w-6xl mx-auto p-6" dir="rtl">
                    
                    {/* Header */}
                    <div className="flex items-center justify-between mb-8 bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                        <div className="flex items-center gap-3">
                            <div className="bg-emerald-600 text-white p-2 rounded-lg">
                                <Database size={24} />
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-gray-800">מערכת הזנת רכבים</h1>
                                <p className="text-sm text-gray-500">
                                    {vehiclePool.length > 0 
                                        ? `מחובר למאגר רכבים (${vehiclePool.length} דגמים)` 
                                        : 'ממתין לטעינת קובץ Vehicle_pool.json...'}
                                </p>
                            </div>
                        </div>
                        
                        <div className="flex items-center gap-4">
                            <label className="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg cursor-pointer text-sm font-medium transition-colors border border-gray-300">
                                <UploadCloud size={18} />
                                <span>טען מאגר (גיבוי)</span>
                                <input type="file" accept=".json" onChange={handleVehiclePoolUpload} className="hidden" />
                            </label>

                            <div className="text-left border-r pr-4 border-gray-300">
                                <span className="text-2xl font-bold text-emerald-600">{carList.length}</span>
                                <span className="text-sm text-gray-500 block">רכבים להורדה</span>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        {/* --- FORM SECTION --- */}
                        <div className="lg:col-span-1 bg-white p-6 rounded-2xl shadow-md border border-gray-200 h-fit sticky top-6 custom-scroll max-h-[90vh] overflow-y-auto">
                            <h2 className="font-bold text-lg mb-4 flex items-center gap-2 border-b pb-2">
                                <Plus size={18} /> הוספת רכב חדש
                            </h2>

                            <form onSubmit={addToList} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-medium text-gray-500 mb-1">לוחית רישוי (Plate) *</label>
                                    <input required name="plate" value={formData.plate} onChange={handleInputChange} className="w-full border p-2 rounded-lg bg-gray-50 text-lg font-mono font-bold tracking-wider outline-none focus:border-blue-500" placeholder="0000000" />
                                </div>

                                {/* URL Field + Extract */}
                                <div>
                                    <label className="block text-xs font-medium text-gray-500 mb-1 flex items-center gap-1">
                                        <LinkIcon size={12} /> קישור לתמונה (Link)
                                    </label>
                                    <div className="flex gap-2">
                                        <input 
                                            type="text" 
                                            name="link"
                                            placeholder="הדבק קישור כאן..." 
                                            value={formData.link}
                                            onChange={handleInputChange}
                                            className="flex-1 border border-blue-200 p-2 rounded-lg text-xs w-full outline-none focus:ring-1 focus:ring-blue-500 text-left"
                                            dir="ltr"
                                        />
                                        <button type="button" onClick={handleUrlImport} className="bg-blue-100 text-blue-700 px-3 rounded-lg text-xs font-medium hover:bg-blue-200 whitespace-nowrap flex items-center gap-1">
                                            <RefreshCw size={12} /> חלץ
                                        </button>
                                    </div>
                                </div>

                                {/* Preview Area */}
                                {previewSrc && (
                                    <div className="relative aspect-video bg-gray-100 rounded-lg overflow-hidden border border-gray-200">
                                        <img 
                                            src={previewSrc} 
                                            alt="Preview" 
                                            className="w-full h-full object-contain"
                                            onError={(e) => {
                                                e.target.style.display = 'none';
                                                setPreviewError(true);
                                            }}
                                            onLoad={() => {
                                                e.target.style.display = 'block';
                                                setPreviewError(false);
                                            }}
                                        />
                                        {previewError && (
                                            <div className="absolute inset-0 flex flex-col items-center justify-center text-gray-400 text-xs text-center p-2">
                                                <ImageIcon size={24} className="mb-1 opacity-50" />
                                                <span>התמונה לא נמצאה בשרת</span>
                                            </div>
                                        )}
                                        <button 
                                            type="button" 
                                            onClick={() => setPreviewSrc(null)} 
                                            className="absolute top-1 right-1 bg-white/80 rounded-full p-1 hover:bg-white text-gray-600"
                                        >
                                            <X size={12} />
                                        </button>
                                    </div>
                                )}

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 mb-1">יצרן (Brand)</label>
                                        <select 
                                            name="brand" 
                                            value={formData.brand} 
                                            onChange={handleInputChange} 
                                            className="w-full border p-2 rounded-lg text-sm bg-white"
                                            disabled={vehiclePool.length === 0}
                                        >
                                            <option value="">בחר יצרן...</option>
                                            {uniqueMakes.map(m => <option key={m} value={m}>{m}</option>)}
                                        </select>
                                        {vehiclePool.length === 0 && <span className="text-[10px] text-red-500">טען מאגר רכבים תחילה</span>}
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 mb-1">דגם (Model)</label>
                                        <select 
                                            name="model" 
                                            value={formData.model} 
                                            onChange={handleInputChange} 
                                            className="w-full border p-2 rounded-lg text-sm bg-white"
                                            disabled={!formData.brand}
                                        >
                                            <option value="">בחר דגם...</option>
                                            {vehiclePool
                                                .filter(c => c.make === formData.brand)
                                                .map((c, idx) => <option key={idx} value={c.modelFamily}>{c.modelFamily}</option>)
                                            }
                                        </select>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 mb-1">שנה (Year)</label>
                                        <input type="number" name="year" value={formData.year} onChange={handleInputChange} className="w-full border p-2 rounded-lg text-sm" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-gray-500 mb-1">צבע (Color)</label>
                                        <input type="text" name="color" value={formData.color} onChange={handleInputChange} className="w-full border p-2 rounded-lg text-sm" />
                                    </div>
                                </div>

                                {/* Find Image Actions */}
                                <div className="grid grid-cols-2 gap-2">
                                    <button 
                                        type="button" 
                                        onClick={() => handleFindImage('side')}
                                        className="flex items-center justify-center gap-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs font-medium py-2 rounded-lg transition-colors border border-indigo-200"
                                    >
                                        <Eye size={14} /> מצא תמונת צד
                                    </button>
                                    <button 
                                        type="button" 
                                        onClick={() => handleFindImage('main')}
                                        className="flex items-center justify-center gap-1 bg-purple-50 hover:bg-purple-100 text-purple-700 text-xs font-medium py-2 rounded-lg transition-colors border border-purple-200"
                                    >
                                        <Eye size={14} /> מצא ישירה (Main)
                                    </button>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-gray-500 mb-1">שם אחראי (Responsible)</label>
                                    <div className="relative">
                                        <input type="text" name="responsible" value={formData.responsible} onChange={handleInputChange} className="w-full border p-2 pl-8 rounded-lg text-sm" placeholder="שם מלא" />
                                        <User size={14} className="absolute left-2 top-3 text-gray-400" />
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-xs font-medium text-gray-500 mb-1">הערות (Notes)</label>
                                    <textarea name="notes" value={formData.notes} onChange={handleInputChange} className="w-full border p-2 rounded-lg text-sm h-16 resize-none"></textarea>
                                </div>

                                <button type="submit" className="w-full bg-gray-900 hover:bg-black text-white py-3 rounded-lg font-bold shadow-lg transition-transform active:scale-95 flex justify-center items-center gap-2">
                                    <Car size={18} /> הוסף לרשימה
                                </button>
                            </form>
                        </div>

                        {/* --- LIST SECTION --- */}
                        <div className="lg:col-span-2 space-y-4">
                            <div className="flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                                <h2 className="font-bold text-lg">רשימת רכבים ליצוא</h2>
                                
                                <div className="flex gap-2">
                                    <button onClick={downloadLinksJSON} disabled={carList.length === 0} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <LinkIcon size={16} /> JSON מקוצר (מס+קישור)
                                    </button>
                                    <button onClick={downloadFullJSON} disabled={carList.length === 0} className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                        <FileJson size={16} /> JSON מלא (הכל)
                                    </button>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                {carList.length === 0 ? (
                                    <div className="text-center py-20 text-gray-400">
                                        <Database size={48} className="mx-auto mb-3 opacity-20" />
                                        <p>הרשימה ריקה. הוסף רכבים מהטופס מימין.</p>
                                    </div>
                                ) : (
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-right">
                                            <thead className="bg-gray-50 text-gray-600 border-b">
                                                <tr>
                                                    <th className="p-3 font-medium">#</th>
                                                    <th className="p-3 font-medium">לוחית</th>
                                                    <th className="p-3 font-medium">קישור</th>
                                                    <th className="p-3 font-medium">רכב</th>
                                                    <th className="p-3 font-medium">אחראי</th>
                                                    <th className="p-3 font-medium">פעולות</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {carList.map((item, idx) => (
                                                    <tr key={idx} className="hover:bg-gray-50">
                                                        <td className="p-3 text-gray-400">{idx + 1}</td>
                                                        <td className="p-3 font-mono font-bold">{item.plate}</td>
                                                        <td className="p-3">
                                                            {item.link ? (
                                                                <a href={item.link} target="_blank" className="text-blue-500 hover:underline text-xs max-w-[100px] truncate block" title={item.link}>
                                                                    פתח קישור
                                                                </a>
                                                            ) : <span className="text-gray-300">-</span>}
                                                        </td>
                                                        <td className="p-3">
                                                            <div className="font-medium">{item.brand} {item.model}</div>
                                                            <div className="text-xs text-gray-500">{item.year} • {item.color}</div>
                                                        </td>
                                                        <td className="p-3 text-gray-600">{item.responsible || '-'}</td>
                                                        <td className="p-3">
                                                            <button onClick={() => removeFromList(idx)} className="text-red-400 hover:text-red-600 hover:bg-red-50 p-1.5 rounded-full transition-colors">
                                                                <Trash2 size={16} />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                            
                            {carList.length > 0 && (
                                <div className="text-center text-xs text-gray-400 mt-4">
                                    סה"כ {carList.length} רכבים מוכנים לייצוא
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<DataCollectorApp />);
        
        setTimeout(() => {
            if (window.lucide) window.lucide.createIcons();
        }, 500);
    </script>
</body>
</html>